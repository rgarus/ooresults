## event_id: Optional[int]
## key: Optional[str]
## view: int


<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>SI reader</title>
        <link rel="stylesheet" href="mystatic/style.css"/>
        <link rel="stylesheet" href="mystatic/style-tab.css"/>
        <style>
            .bgr {background-color: #ff7070;}
            .bgy {background-color: #ffff00;}
            .bgg {background-color: #70ff70;}
            .s1 {font-size: 1.5em;}
            .s2 {font-size: 2.5em;}
            .vertical-center {
                display: flex;
                align-items: center;
                padding-left: 4%;
        </style>
    </head>
    <body style="margin: 0">
        <div id="page"></div>

        <div class="modal" id="si1.tlsErrorDialog">
            <!-- Modal content -->
            <div class="modal-content">
                <span class="close" onclick="closeErrorDialog()">&times;</span>
                <p>TLS handshake error, try to open <a id="si1.tlsErrorLink" target="_blank"></a></p>
                <button type="button" class="btn cancel" onclick="closeErrorDialog()">Close</button>
            </div>
        </div>

        <script>
            var event_id = "${event_id}";
            var key = "${key | f, n}";
            var view = ${view};  // 0: both, 1: only reader

            var ws_uri;
            if (window.location.protocol === "https:") {
                ws_uri = "wss:";
            } else {
                ws_uri = "ws:";
            };
            ws_uri += "//" + window.location.hostname + ":8081" + window.location.pathname;

            /* Function to open fullscreen mode */
            function openFullscreen() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
            };

            var timer = null;
            var status = 'offline';
            var data = '';
            var resultData = null;
            var newResultReceived = false;
            var autoscrollTimer = null;

            function message () {
                var text = '';
                var color = 'black';

                switch (status) {
                    case 'offline':
                        text = 'Offline';
                        color = 'red';
                        break;
                    case 'noAccess':
                        text = 'No access rights';
                        color = 'red';
                        break;
                    case 'online':
                        text = 'Online';
                        break;
                    case 'readerOffline':
                        text = 'Card reader offline';
                        color = 'red';
                        break;
                    case 'readerDisconnected':
                        text = 'Card reader disconnected';
                        color = 'red';
                        break;
                    case 'readerConnected':
                    case 'cardRemoved':
                        text = 'Card reader connected';
                        break;
                    case 'cardInserted':
                        text = 'Reading card ' + data + ' ...';
                        break;

                }
                if (autoscrollTimer != null) {
                    clearTimeout(autoscrollTimer);
                };

                if (resultData && (status == 'readerConnected' || status == 'cardRemoved')) {
                    showResult(resultData);
                    autoscroll();
                } else {
                    showMessage(text, color);
                }
            };

            function showMessage(text, color) {
                document.getElementById('page').innerHTML =
                    '<p style="text-align: right; margin: 10px"><button onclick="openFullscreen();">' + window.wakeStatus + '</button></p>' +
                    '<p class="s2" style="padding-left: 4%; color: ' + color + '">' + text + '</p>';
            };

            function showResult(resultData) {
                if (newResultReceived) {
                    newResultReceived = false;
                    document.getElementById('page').innerHTML =
                        '<p style="text-align: right; margin: 10px"><button onclick="openFullscreen();">' + window.wakeStatus + '</button></p>' +
                        '<div style="padding-left: 4%; padding-bottom: 24px">' + resultData + '</div>';
                }
            };

            function closeErrorDialog() {
                document.getElementById('si1.tlsErrorDialog').style.display='none';
                start(ws_uri);
            };

            function start(websocketServerLocation) {
                var ws = new WebSocket(websocketServerLocation);
                var tm = null;
                var tp = null;
                var elem = document.getElementById('page')

                ws.onopen = function(event) {
                    ws.send(event_id + ',' + key + ',' + (view == 0).toString());
                    status = 'online';
                    message();
                    tp = setTimeout(function() {ping()}, 10000);
                };
                ws.onclose = function(event) {
                    ws = null;
                    clearTimeout(tm);
                    clearTimeout(tp);

                    if (event.code == 1015) {
                        message();
                        var uri = window.location.protocol + "//" + window.location.hostname + ":8081";
                        document.getElementById('si1.tlsErrorLink').href = uri;
                        document.getElementById('si1.tlsErrorLink').text = uri;
                        document.getElementById('si1.tlsErrorDialog').style.display='block';
                    } else if (status != 'noAccess') {
                        status = 'offline';
                        message();
                        // Try to reconnect in 5 seconds
                        setTimeout(function() {start(websocketServerLocation)}, 5000);
                    }
                };
                ws.onmessage = function(event) {
                    var msg = event.data;
                    if (msg == '__pong__') {
                        pong();
                        return;
                    }
                    if (msg == '__no_access__') {
                        ws.close();
                        status = 'noAccess';
                        message();
                        return;
                    }
                    const obj = JSON.parse(event.data)
                    if (obj.status == 'result') {
                        if (view == 0) {
                            var firstResult = !resultData
                            resultData = obj.data;
                            newResultReceived = true;
                            if (firstResult && (status == 'readerConnected' || status == 'cardRemoved')) {
                                showResult(resultData);
                                autoscroll();
                            }
                        }
                        return;
                    }
                    clearTimeout(timer);
                    if (obj.status == 'cardRead') {
                        status = 'readerConnected';
                        document.getElementById('page').innerHTML = obj.data;
                        timer = setTimeout(message, 15000);
                    } else if (obj.status != null) {
                        status = obj.status;
                        data = obj.data;
                        message();
                    }
                };

                // workaround to detect lost websocket connection in the browser
                // see https://stackoverflow.com/questions/26971026/handling-connection-loss-with-websockets
                function ping() {
                    ws.send('__ping__');
                    tm = setTimeout(function() {nopong()}, 10000);
                };
                function pong() {
                    clearTimeout(tm);
                    tp = setTimeout(function() {ping()}, 15000);
                };
                function nopong() {
                    ws.close();
                };
            };

            start(ws_uri);

            function autoscroll() {
                if (window.scrollY == 0) {
                    showResult(resultData);
                    autoscrollTimer = setTimeout(function() {window.scrollBy(0, 2); autoscroll()}, 2000);
                } else if (window.scrollY + 1 < document.documentElement.scrollHeight - window.innerHeight) {
                    autoscrollTimer = setTimeout(function() {window.scrollBy(0, 2); autoscroll()}, 25);
                } else {
                    autoscrollTimer = setTimeout(function() {window.scrollTo(0, 0); autoscroll()}, 2000);
                };
            };
        </script>

        <script>
            // prevent screen from dimming or locking
            // see https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API
            var isSupported = false;
            var wakeStatus = '&nbsp;';

            if ('wakeLock' in navigator) {
                isSupported = true;
            }

            if (isSupported) {
                // create a reference for the wake lock
                var wakeLock = null;

                // create an async function to request a wake lock
                const requestWakeLock = async () => {
                    try {
                        wakeLock = await navigator.wakeLock.request('screen');

                        // change up our interface to reflect wake lock active
                        wakeStatus = 'wake on';

                        wakeLock.addEventListener('release', () => {
                            // if wake lock is released alter the button accordingly
                            wakeStatus = '&nbsp;';
                        });

                    } catch (err) {
                        // if wake lock request fails - usually system related, such as battery
                        wakeStatus = '&nbsp;';

                    }
                } // requestWakeLock()

                requestWakeLock()

                const handleVisibilityChange = () => {
                    if (wakeLock !== null && document.visibilityState === 'visible') {
                        requestWakeLock();
                    }
                }

                reaquireCheck.addEventListener('change', () => {
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                });

            } // isSupported
        </script>

    </body>
</html>
 
